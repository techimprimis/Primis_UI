<ion-content class="ion-padding">
  <div class="reset-password-container">
        @if (!tokenValid()) {
          <!-- Invalid Token State -->
          <div class="error-state">
            <div class="error-icon-container">
              <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
            </div>
            <h1 class="card-title">Invalid or Expired Link</h1>
            <p class="card-subtitle">
              This password reset link is invalid or has expired. Please request a new password reset link.
            </p>

            <ion-button
              expand="block"
              routerLink="/forgot-password"
              class="primary-btn"
            >
              Request New Link
            </ion-button>

            <ion-button
              expand="block"
              fill="outline"
              routerLink="/login"
              class="secondary-btn"
            >
              Back to Sign In
            </ion-button>
          </div>
        } @else if (!resetSuccess()) {
          <!-- Reset Password Form -->
          <div class="card-header">
            <div class="icon-container">
              <ion-icon name="lock-closed-outline" class="header-icon"></ion-icon>
            </div>
            <h1 class="card-title">Reset Password</h1>
            <p class="card-subtitle">Enter your new password below. Make sure it's strong and secure.</p>
          </div>

          <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()">
            <ion-input
              formControlName="password"
              type="password"
              label="New Password"
              labelPlacement="stacked"
              placeholder="Enter your new password"
              autocomplete="new-password"
              fill="outline"
              class="input-field"
            >
              <ion-input-password-toggle slot="end"></ion-input-password-toggle>
            </ion-input>

            <!-- Password Strength Indicator -->
            @if (passwordControl?.value) {
              <div class="password-strength">
                <div class="strength-bar">
                  <div
                    class="strength-fill"
                    [style.width]="getPasswordStrength().width"
                    [attr.data-strength]="getPasswordStrength().color"
                  ></div>
                </div>
                <span class="strength-label" [attr.data-strength]="getPasswordStrength().color">
                  {{ getPasswordStrength().label }}
                </span>
              </div>
            }

            @if (passwordControl?.touched && passwordControl?.errors) {
              <ion-text color="danger" class="error-message">
                @if (passwordControl?.errors?.['required']) {
                  <small>Password is required</small>
                } @else if (passwordControl?.errors?.['minlength']) {
                  <small>Password must be at least 8 characters</small>
                } @else if (passwordControl?.errors?.['passwordStrength']) {
                  <small>Password must include uppercase, lowercase, and a number</small>
                }
              </ion-text>
            }

            <ion-input
              formControlName="confirmPassword"
              type="password"
              label="Confirm Password"
              labelPlacement="stacked"
              placeholder="Confirm your new password"
              autocomplete="new-password"
              fill="outline"
              class="input-field"
            >
              <ion-input-password-toggle slot="end"></ion-input-password-toggle>
            </ion-input>
            @if (confirmPasswordControl?.touched && (confirmPasswordControl?.errors || resetPasswordForm.errors?.['passwordMismatch'])) {
              <ion-text color="danger" class="error-message">
                @if (confirmPasswordControl?.errors?.['required']) {
                  <small>Please confirm your password</small>
                } @else if (resetPasswordForm.errors?.['passwordMismatch']) {
                  <small>Passwords do not match</small>
                }
              </ion-text>
            }

            <ion-button
              type="submit"
              expand="block"
              class="submit-btn"
              [disabled]="isLoading()"
            >
              @if (isLoading()) {
                <ion-spinner name="crescent"></ion-spinner>
              } @else {
                Reset Password
              }
            </ion-button>
          </form>
        } @else {
          <!-- Success State -->
          <div class="success-state">
            <div class="success-icon-container">
              <ion-icon name="checkmark-circle-outline" class="success-icon"></ion-icon>
            </div>
            <h1 class="card-title">Password Reset Successfully!</h1>
            <p class="card-subtitle">
              Your password has been updated. You can now sign in with your new password.
            </p>

            <ion-button
              expand="block"
              routerLink="/login"
              class="primary-btn"
            >
              Sign In Now
            </ion-button>
          </div>
        }
      <!-- End main content -->
  </div>
</ion-content>
